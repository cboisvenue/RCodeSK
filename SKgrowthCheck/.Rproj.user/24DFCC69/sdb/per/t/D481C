{
    "collab_server" : "",
    "contents" : "#------------------------------------------------------------------------------------\n# Building a yield table for use in base-CBM runs for SK\n# Goals:\n# 1) tree-level volume increment calculations \n# 2) plot-level increment summaries\n# 3) yearly per ha increments\n# 4) stratification\n# 5) Fit yield curve\n#\n# CBoisvenue\n# June 22nd, 2015\n#------------------------------------------------------------------------------------\n\n#library(nlme)\nlibrary(ggplot2)\nlibrary(RColorBrewer)\nrequire(plyr)\nrequire(dplyr)\nlibrary(tidyr)\n\nsetwd(\"C:/Celine/CelineSync/RES_Work/Work/JoanneWhite/SK_work/data/CleanedUpForUsing/\")\n\n# read-in base file-----------------------\ntree.vol <-read.table(\"SK2000_treeVol.txt\",header=TRUE,sep=\",\")\n\n# calculate tree-level increments in merch vol------------------------------------------------------------\n\n# how many trees have >1 measurements?\ntrees <- group_by(tree.vol,PLOT_ID,TREE_NO,YEAR) %>%\n  summarize(sps = first(SPECIES),ht=mean(HEIGHT),age=mean(age),merch=mean(merchvol),dbh=mean(dbh)) %>%\n  rename(target.yr = YEAR)\nmeas.tree <- arrange(trees,PLOT_ID,target.yr,TREE_NO) %>%\n  group_by(PLOT_ID,TREE_NO) %>%\n  summarize(no.meas=n(),first.yr=first(target.yr),last.yr=last(target.yr)) %>%\n  filter(no.meas>1)\ndim(meas.tree)#   104557      3\nrange(meas.tree$no.meas)\ntable(meas.tree$no.meas)\n# 2     3     4     5 \n# 68032 23686 11680  1159 \n\n# calculating differences in merch between measurements-------------------------------\n# allmerch <- select(trees,PLOT_ID, TREE_NO,target.yr,merch)\n# merch1 <- spread(allmerch,target.yr,merch)\n# THE ABOVE WORKS (puts it wide...) but I cannot figure out how to substract the right columns \n# for each measurement interval...\n#colSums(merch1[,3:45],na.rm=TRUE)\n\n############## THis is the per tree approach: calculate the increment per tree per year, and sum\n### the per tree per year increment for the whole plot. Convert to inc.ha.yr for that plot \n#################################################################################################\n\n# Dealing with the plot/tree combos with 2 measurements only--------------------------------------\nsurvey2 <-  filter(meas.tree,no.meas==2) \nmeas2.merch1 <- select(survey2,PLOT_ID,TREE_NO,target.yr=first.yr)%>%\n  left_join(trees) %>%\n  rename(yr1=target.yr,ht1=ht,age1=age,merch1=merch,dbh1=dbh)\nmeas2.merch2 <- select(survey2,PLOT_ID,TREE_NO,target.yr=last.yr)%>%\n  left_join(trees) %>%\n  rename(yr2=target.yr,ht2=ht,age2=age,merch2=merch,dbh2=dbh)\nmeas2.delta <- inner_join(meas2.merch2,meas2.merch1) %>%#note: we lost one tree here...weird\n  mutate(yr.delta = yr2-yr1,ht.delta=ht2-ht1,age.delta=age2-age1,dbh.delta=dbh2-dbh1,merch.delta=merch2-merch1,\n         inc.yr = merch.delta/yr.delta) %>%\n  select(PLOT_ID,TREE_NO,first.yr = yr1,inc.yr,age1)\n# how many negatives?\ndim(filter(meas2.delta,inc.yr<0)) #[1] 11398     6\n# can't keep those\nmeas2.inc <- filter(meas2.delta, inc.yr>=0)\n# End of trees measured twice -------------------------------------------------------------------\n\n\n# Dealing with the plot/tree combos with 3 measurements----------------------------------------\nsurvey3 <- filter(meas.tree,no.meas==3)\nmeas3.merch1 <- select(survey3,PLOT_ID,TREE_NO,target.yr=first.yr)%>%\n  left_join(trees) %>%\n  rename(yr1=target.yr,age1=age,merch1=merch) %>% #dbh1=dbh ht1=ht,\n  select(-sps,-ht,-dbh)\n# how do I get that middle year??\nmeas3.merch2 <- left_join(survey3,trees) %>%\n  filter(target.yr!=first.yr & target.yr!=last.yr) %>%\n  rename(yr2=target.yr,age2=age,merch2=merch) %>% #ht2=ht,dbh2=dbh\n  select(-no.meas,-sps,-ht,-dbh)\nmeas3.merch3 <- select(survey3,PLOT_ID,TREE_NO,target.yr=last.yr)%>%\n  left_join(trees) %>%\n  rename(yr3=target.yr,age3=age,merch3=merch) %>%#ht3=ht,,dbh3=dbh\n  select(-sps,-ht,-dbh)\nmeas3.delta <- inner_join(meas3.merch3,meas3.merch2) %>%\n  inner_join(meas3.merch1) %>%\n  # range(meas3.delta$yr1-meas3.delta$first.yr)# 0 0 \n  # range(meas3.delta$yr3-meas3.delta$last.yr)# 0 0\n  mutate(yr.delta1 = yr2-yr1,merch.delta1=merch2-merch1,\n         inc.yr1 = merch.delta1/yr.delta1,yr.delta2 = yr3-yr2,merch.delta2=merch3-merch2,\n         inc.yr2 = merch.delta2/yr.delta2) %>%\n  select(-merch1,-merch2,-merch3,-first.yr,-last.yr)\nmeas3.1 <-  select(meas3.delta, PLOT_ID,TREE_NO,first.yr=yr1,inc.yr=inc.yr1,age1=age1) %>%\n  filter(inc.yr>=0)\nmeas3.2 <-  select(meas3.delta, PLOT_ID,TREE_NO,first.yr=yr2,inc.yr=inc.yr2,age1=age2) %>%\n  filter(inc.yr>=0)\nmeas3.inc <- rbind(meas3.1,meas3.2)\n# End of trees measured thrice -------------------------------------------------------------------\n\n# Dealing with the plot/tree combos with 4 measurements----------------------------------------\nsurvey4 <- filter(meas.tree,no.meas==4)\nmeas4.merch1 <- select(survey4,PLOT_ID,TREE_NO,target.yr=first.yr)%>%\n  left_join(trees) %>%\n  rename(yr1=target.yr,age1=age,merch1=merch) %>% #dbh1=dbh ht1=ht,\n  select(-sps,-ht,-dbh)\n\n# how do I get that middle year??\nmeas4.merch2 <- left_join(survey4,trees) %>%\n  filter(target.yr!=first.yr & target.yr!=last.yr) \n\n# first last of this one-------------\n    mid.yrs <- arrange(meas4.merch2,PLOT_ID,target.yr,TREE_NO) %>%\n      group_by(PLOT_ID,TREE_NO) %>%\n      summarize(yr2=first(target.yr),yr3=last(target.yr))\n    mid.yr1 <- left_join(mid.yrs,trees) %>%\n      filter(yr2==target.yr) %>%\n      select(PLOT_ID,TREE_NO,yr2,age2=age,merch2=merch)\n    mid.yr2 <- left_join(mid.yrs,trees) %>%\n      filter(yr3==target.yr) %>%\n      select(PLOT_ID,TREE_NO,yr3,age3=age,merch3=merch)\n# Mid-years done--------------------\n\nmeas4.merch4 <- select(survey4,PLOT_ID,TREE_NO,target.yr=last.yr)%>%\n  left_join(trees) %>%\n  rename(yr4=target.yr,age4=age,merch4=merch) %>%#ht3=ht,,dbh3=dbh\n  select(-sps,-ht,-dbh)\nmeas4.delta <- inner_join(meas4.merch1,mid.yr1) %>%\n  inner_join(mid.yr2) %>%\n  inner_join(meas4.merch4) %>%\n  mutate(yr.delta1 = yr2-yr1,merch.delta1=merch2-merch1,\n         inc.yr1 = merch.delta1/yr.delta1,yr.delta2 = yr3-yr2,merch.delta2=merch3-merch2,\n         inc.yr2 = merch.delta2/yr.delta2,yr.delta3 = yr4-yr3,merch.delta3=merch4-merch3,\n         inc.yr3 = merch.delta3/yr.delta3) %>%\n  select(PLOT_ID,TREE_NO, yr1,yr2,yr3,age1,age2,age3,contains(\"inc.\"))\nmeas4.1 <-  select(meas4.delta, PLOT_ID,TREE_NO,first.yr=yr1,inc.yr=inc.yr1,age1=age1) %>%\n  filter(inc.yr>=0)\nmeas4.2 <-  select(meas4.delta, PLOT_ID,TREE_NO,first.yr=yr2,inc.yr=inc.yr2,age1=age2) %>%\n  filter(inc.yr>=0)\nmeas4.3 <-  select(meas4.delta, PLOT_ID,TREE_NO,first.yr=yr3,inc.yr=inc.yr3,age1=age3) %>%\n  filter(inc.yr>=0)\nmeas4.inc <- rbind(meas4.1,meas4.2,meas4.3)\n# End of trees measured four times -------------------------------------------------------------------\n\n\n# Dealing with the plot/tree combos with 5 measurements----------------------------------------\nsurvey5 <- filter(meas.tree,no.meas==5)\nmeas5.merch1 <- select(survey5,PLOT_ID,TREE_NO,target.yr=first.yr)%>%\n  left_join(trees) %>%\n  rename(yr1=target.yr,age1=age,merch1=merch) %>% #dbh1=dbh ht1=ht,\n  select(-sps,-ht,-dbh)\n\n# get those middle year\nmeas5.merch2 <- left_join(survey5,trees) %>%\n  filter(target.yr!=first.yr & target.yr!=last.yr) \n\n# first last of this one-------------\nmid.yrs <- arrange(meas5.merch2,PLOT_ID,target.yr,TREE_NO) %>%\n  group_by(PLOT_ID,TREE_NO) %>%\n  summarize(yr2=first(target.yr),yr4=last(target.yr))\nmid.yr1 <- left_join(mid.yrs,trees) %>%\n  filter(yr2==target.yr) %>%\n  select(PLOT_ID,TREE_NO,yr2,age2=age,merch2=merch)\nmid.yr3 <- left_join(mid.yrs,trees) %>%\n  filter(yr4==target.yr) %>%\n  select(PLOT_ID,TREE_NO,yr4,age4=age,merch4=merch)\nmid.yr2 <- left_join(mid.yrs,meas5.merch2) %>%\n  filter(target.yr!=yr2 & target.yr!=yr4) %>%\n  select(PLOT_ID,TREE_NO,yr3=target.yr,age3=age,merch3=merch)\n# Mid-years done--------------------\n\nmeas5.merch5 <- select(survey5,PLOT_ID,TREE_NO,target.yr=last.yr)%>%\n  left_join(trees) %>%\n  rename(yr5=target.yr,age5=age,merch5=merch) %>%#ht3=ht,,dbh3=dbh\n  select(-sps,-ht,-dbh)\n\nmeas5.delta <- inner_join(meas5.merch1,mid.yr1) %>%\n  inner_join(mid.yr2) %>%\n  inner_join(mid.yr3) %>%\n  inner_join(meas5.merch5) %>%\n  mutate(yr.delta1 = yr2-yr1,merch.delta1=merch2-merch1,\n         inc.yr1 = merch.delta1/yr.delta1,yr.delta2 = yr3-yr2,merch.delta2=merch3-merch2,\n         inc.yr2 = merch.delta2/yr.delta2,yr.delta3 = yr4-yr3,merch.delta3=merch4-merch3,\n         inc.yr3 = merch.delta3/yr.delta3,yr.delta4 = yr5-yr4,merch.delta4=merch5-merch4,\n         inc.yr4 = merch.delta4/yr.delta4) %>%\n  select(PLOT_ID,TREE_NO, yr1,yr2,yr3,yr4,age1,age2,age3,age4,contains(\"inc.\"))\nmeas5.1 <-  select(meas5.delta, PLOT_ID,TREE_NO,first.yr=yr1,inc.yr=inc.yr1,age1=age1) %>%\n  filter(inc.yr>=0)\nmeas5.2 <-  select(meas5.delta, PLOT_ID,TREE_NO,first.yr=yr2,inc.yr=inc.yr2,age1=age2) %>%\n  filter(inc.yr>=0)\nmeas5.3 <-  select(meas5.delta, PLOT_ID,TREE_NO,first.yr=yr3,inc.yr=inc.yr3,age1=age3) %>%\n  filter(inc.yr>=0)\nmeas5.4 <-  select(meas5.delta, PLOT_ID,TREE_NO,first.yr=yr4,inc.yr=inc.yr4,age1=age4) %>%\n  filter(inc.yr>=0)\nmeas5.inc <- rbind(meas5.1,meas5.2,meas5.3,meas5.4)\n\n# End of trees measured five times -------------------------------------------------------------------\n\n# put them all together: this contains inc per year per tree (m3/yr for each record)\ninc.yr <- rbind(meas2.inc,meas3.inc,meas4.inc,meas5.inc)\ntree.inc <- select(inc.yr,-first.yr)\n# get plot sizes\nplot.size <-read.table(\"C:/Celine/CelineSync/RES_Work/Work/JoanneWhite/SK_work/GrowthRaster/BiomassEstimation/measurement_header.csv\",sep=\",\", header=TRUE)\nplot.size <- plot.size[,c(1,3)]\nplot.size <- unique(plot.size)\ndom.sps <- read.table(\"C:/Celine/CelineSync/RES_Work/Work/JoanneWhite/SK_work/data/CleanedUpForUsing/SK_2000TreeMEasurements.csv\",sep=\",\", header=TRUE)\ndom.sps <-group_by(dom.sps,PLOT_ID) %>%\n  summarise(dom=first(SPECIES))\n###\n# there are not enough plots with leaving TL so they ae lumped-in with the BF\ndom.sps$dom[which(dom.sps$dom==\"TL\")] <- \"BF\"\n##\n\n# Creating strata--------------------------------------------------------------------------------\ncasfri <- read.table(\"C:/Celine/CelineSync/RES_Work/Work/JoanneWhite/SK_work/data/CleanedUpForUsing/casfri.txt\",sep=\",\", header=TRUE)\nsoil <- select(casfri, PLOT_ID=plot_id, soil_moist_reg) \n\n# taking the 5 soil_moist_reg classes and making them into 3 productivity classes: \n# moist(M) and mesic(F) = good(G), dry(D) and wet(W) = average(M), aquatic(A) = poor(P)\nsoil$soil_moist_reg <- revalue(soil$soil_moist_reg,c(\"-1111\" = \"M\",\"A\"=\"P\",\"D\"=\"M\",\"F\"=\"G\",\"M\"=\"G\",\"W\"=\"M\"))\nsoil$soil_moist_reg[which(is.na(soil$soil_moist_reg))] <- \"M\"\nplot.inc <- group_by(tree.inc,PLOT_ID) %>%\n  summarise(plot.yr.inc = sum(inc.yr),plot.age=mean(age1)) %>%\n  inner_join(plot.size) %>%\n  mutate(m3.ha.yr = plot.yr.inc/PLOT_SIZE) %>%\n  inner_join(soil) %>%\n  inner_join(dom.sps) %>%\n  select(PLOT_ID,plot.age,m3.ha.yr,prodClass=soil_moist_reg,dom)\n\n# from some assessment (below), there will be a total of 10 strata\nstratum <- (as.numeric(plot.inc$dom)*10)+(as.numeric(plot.inc$prodClass))\nstratum[which(stratum<15)] <- \"BF\"\nstratum[which(stratum<25 & stratum>15)] <- \"BP\"\nstratum[which(stratum>25 & stratum<33)] <- \"BSM\"\nstratum[which(stratum==33)] <- \"BSG\"\nstratum[which(stratum>40 &stratum<60)] <- \"JP\"\nstratum[which(stratum>60 &stratum<63)] <- \"TAM\"\nstratum[which(stratum==63)] <- \"TAG\"\nstratum[which(stratum>65 &stratum<85)] <- \"WB\"\nstratum[which(stratum>90 &stratum<93)] <- \"WSM\"\nstratum[which(stratum==93)] <- \"WSG\"\n\nplot.inc <- cbind(plot.inc[,1:3],stratum)\nstrata <- group_by(plot.inc,stratum) %>%\n  summarise(count=n())\nin.yr <- ggplot(data=plot.inc,aes(x=plot.age,y=m3.ha.yr)) + geom_point()\nin.yr + geom_point(aes(colour=factor(stratum)))\nggsave(\"Yield_strata.jpeg\")\nwrite.table(x=plot.inc,file=\"Plot_Inc_m3_ha_yr.txt\",sep=\",\",row.names=FALSE)  \n################# END OF BY TREE BY YEAR INC ###############################\n\n####### Total volume per plot for \"GROWTH\" ###############################\n## SUM MERCH BY PLOT BY YEAR (THIS WOULD BE USED TO FIT A GROWTH CURVE AS OPPOSED \n#### TO A YIELD CURVE) \n# this let's me check the range of volumes to make sure that they make sense\n\nplot.vol <- group_by(trees, PLOT_ID, target.yr) %>%\n  summarise(plot.vol = sum(merch),plot.age = mean(age)) %>%\n  inner_join(plot.size) %>%\n  mutate(totalm3_ha = plot.vol/PLOT_SIZE) %>%\n  inner_join(soil) %>%\n  inner_join(dom.sps) %>%\n  select(PLOT_ID,target.yr,plot.age, totalm3_ha, prodClass=soil_moist_reg,dom)\n\n# creating one colum that represents all 7 species with each a prodClass (3), \n# so 21 possible values\nlevels(plot.vol$dom)\n#[1] \"BF\" \"BP\" \"BS\" \"JP\" \"MM\" \"TA\" \"TL\" \"WB\" \"WS\"\nlevels(plot.vol$prodClass)\n#[1] \"M\" \"P\" \"G\"\nstratum <- (as.numeric(plot.vol$dom)*10)+as.numeric(plot.vol$prodClass)\nplot.vol <- cbind(plot.vol,stratum)\n\nrange(plot.vol$totalm3_ha) #[1]   0.1640795 621.5990926\nggplot(data=plot.vol) + geom_point(aes(x=plot.age,y=totalm3_ha),colour=factor(stratum))\nggsave(\"totalVol_haPlot.jpeg\")\nwrite.table(x=plot.vol,file=\"totalVol_haPlot.txt\",sep=\",\",row.names=FALSE)  \n\n############ END OF GROWTH ##############################################\n\n\n\n\n\n\n\n\n\n\n\n",
    "created" : 1496963934159.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1859024083",
    "id" : "D481C",
    "lastKnownWriteTime" : 1459373154,
    "last_content_update" : 1459373154,
    "path" : "C:/Celine/GitHub/RCodeSK/VolumenIncrements.r",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}