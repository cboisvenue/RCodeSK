{
    "collab_server" : "",
    "contents" : "# ---------------------------------------------------------------------------\n# Growth curves for the purposes of creating growth tables for CBMCFS3 runs \n# SK. by strata for the \"basic\" spatial CBM-CFS3 runs in SK\n# \n# June 26, 2016\n# CBoisvenue\n#---------------------------------------------------------------------------\n\n\n#library(nlme)\nlibrary(ggplot2)\nrequire(plyr)\nrequire(dplyr)\n\n# Read-in data\nsetwd(\"C:/Celine/CelineSync/RES_Work/Work/JoanneWhite/SK_work/data/CleanedUpForUsing/\")\n\n#yield.data <- read.table(\"Plot_Inc_m3_ha_yr.txt\",sep=\",\",header=TRUE)\ntotal.vol <-  read.table(\"totalVol_haPlot.txt\",sep=\",\",header=TRUE)\nhist(total.vol$totalm3_ha)\n\n\n#install.packages(\"lme4\")\nlibrary(lme4)\n\n\n# linearize this model-----------------------------------------------------------\ndataT1 <- select(total.vol,PLOT_ID,plot.age,totalm3_ha,stratum=stratum.1) %>%\n  mutate(ltotvol = log(totalm3_ha),l.age=log(plot.age))\n\n# Trying total vol -----------------------------------------------------\nglmT1 <- glm(ltotvol~stratum+l.age+plot.age,data=dataT1)\nglmT2 <- glm(ltotvol~stratum+l.age*stratum+plot.age*stratum,data=dataT1)\nanova(glmT1,glmT2,test=\"F\")\nAIC(glmT1)#6333.412\nAIC(glmT2)#6283.533\n\n## only one slope varies with strata\nglmT3 <- glm(ltotvol~stratum+l.age*stratum+plot.age,data=dataT1)\nAIC(glmT3)#[1] 6326.133\n\n# try mem---------------------------------------\nlibrary(lme4)\nmemT <- lmer(formula= ltotvol~stratum+l.age*stratum+plot.age*stratum+(1|PLOT_ID),data=dataT1,REML=FALSE)\nAIC(memT)#[1] 3589.153\nanova(glmT2,memT)\nmemT1 <- lmer(formula= ltotvol~stratum+l.age*stratum+plot.age+(1|PLOT_ID),data=dataT1,REML=FALSE)\nAIC(memT1)#3765.832\n##################################################################################\n#BEST MODEL TOTAL VOL: varying intercepts, and slopes for each stratum (fixed)\n# and random effects on plot_ID\nsummary(memT)\nmemT.lyhat <- fitted(memT)\nplot(dataT1$ltotvol,memT.lyhat)\nobs.pred1 <- lm(memT.lyhat~dataT1$ltotvol)\n# Residual standard error: 0.1862 on 3708 degrees of freedom\n# Multiple R-squared:  0.9434,\tAdjusted R-squared:  0.9434 \n#\n# PROBLEM WITH TAG??\nplot(dataT1$ltotvol[which(dataT1$stratum==\"TAG\")],memT.lyhat[which(dataT1$stratum==\"TAG\")])\n# Get rid of TAG and refit-----------------------\ndataT3 <-filter(dataT1, stratum!=\"TAG\")\ndataT3$stratum <- as.character(dataT3$stratum)\n\n\n# try again\nmemTnotag <- lmer(formula= ltotvol~stratum+l.age*stratum+plot.age*stratum+(1|PLOT_ID),data=dataT3,REML=FALSE)\nAIC(memTnotag)#[1] 2736.334\n## BEST MODEL FOR TOTAL VOLUME DOES NOT HAVE TAG DATA##############################\n\n\n#Pretty curves? predict from this for each stratum?------------------------------------\nplot.age <- rep(1:250)\nl.age <-log(plot.age)\n\ntopredMM <- as.data.frame(cbind(plot.age,l.age))\nnames(topredMM) = c(\"plot.age\",\"l.age\")\n# for total volume with TAG model: memT\nstratum <- sort(rep(as.character(levels(dataT1$stratum)),250))\nplot10 <- sample(dataT1$PLOT_ID,10)\nPLOT_ID <- sort(rep(plot10,250))\ntopredMM <- cbind(PLOT_ID,stratum,topredMM)\n\nlyhat <- predict(memT,newdata=topredMM)\npredMM1 <- cbind(topredMM,lyhat)\npredMM  <- mutate(predMM1 ,memTyhat = exp(lyhat)) \nMEM_all <- ggplot(data=predMM,aes(x=plot.age,y=memTyhat,group=stratum,colour=stratum)) + geom_line(size=1.5)\nMEM_all + ggtitle(\"Predicting total m3/ha by Strata\") +  scale_fill_brewer(palette=\"Spectral\")\n# CAN SEE THE TAG issue here - have tried all kinds of other \n# solutions (see YieldCurveFittingScratch.r) and chose to remove the TAG lines and refit\n\n# for total volume no TAG model: memTnotag\ntopredMM <- as.data.frame(cbind(plot.age,l.age))\nnames(topredMM) = c(\"plot.age\",\"l.age\")\nstratum <- stratum[which(stratum!=\"TAG\")]\nplot10 <- sample(dataT3$PLOT_ID,9)\nPLOT_ID <- sort(rep(plot10,250))\ntopredMM <- cbind(PLOT_ID,stratum,topredMM)\n\nnoTAGlyhat <- predict(memTnotag,newdata=topredMM)\nnoTAGMM <- cbind(topredMM,noTAGlyhat)\nnoTAGMM  <- mutate(noTAGMM ,memT.notagyhat = exp(noTAGlyhat)) \n\n\nMEM_noTAG <- ggplot(data=noTAGMM,aes(x=plot.age,y=memT.notagyhat,group=stratum,colour=stratum)) + geom_line(size=1.5)\nMEM_noTAG + ggtitle(\"Predicting total m3/ha by Strata\") +  scale_fill_brewer(palette=\"Spectral\")\nggsave(\"plotGrowthCurvesMEModelPSP2_noTAG.jpeg\")\n\nwrite.table(noTAGMM,file=\"MEMPredictedGrowth_noTAG.txt\",sep=\",\",row.names=FALSE)\nsave(memTnotag,file = \"GrowthCurvesMEModel_noTAG.RData\")\n# end of pretty graphs--------------------------------------\n\n\n# build growth tables for CBM----------------\n\n# add TAG\nTAG <- noTAGMM[noTAGMM$stratum==\"TAM\",]\nTAG$stratum <- \"TAG\"\nTvolCBM <- rbind(noTAGMM,TAG)\n\nlibrary(reshape2)\ngrowth.table.out <- dcast(TvolCBM,stratum~plot.age,value.var=\"memT.notagyhat\")\n\nstrata.def <-read.table(\"YieldCurveStrata.csv\",sep=\",\",header=TRUE)\nstrata.def <- select(strata.def,dom,prodClass, stratum)\n\ngrowth.table.out <-left_join(strata.def,growth.table.out)\n\nwrite.table(growth.table.out,file=\"GrowthTables_PSP_forCBM.txt\",row.names=FALSE,sep=\",\")\n\n# trying to figure out what was giving to Byron for the spatial simulations\n\nggplot(data=noTAGMM,aes(x=plot.age,y=memT.notagyhat,group=stratum,colour=stratum)) +\n  geom_line(size=1)\n",
    "created" : 1496965666105.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3153525811",
    "id" : "3B93500F",
    "lastKnownWriteTime" : 1459373154,
    "last_content_update" : 1459373154,
    "path" : "C:/Celine/GitHub/RCodeSK/Yield_CurveFitting.r",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}